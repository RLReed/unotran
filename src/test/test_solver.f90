program test_solver
  call test1()
  call test2()
  call test3()
  call test4()
end program test_solver

! Test against detran with vacuum conditions
subroutine test1()
  use control
  use solver

  implicit none
  
  ! initialize types
  integer :: testCond, t1
  double precision :: phi_test(7,28)
  
  ! Define problem parameters
  call initialize_control('test/reg_test_options', .true.)
  xs_name = 'test/testXS.anlxs'
  allow_fission = .true.
  
  call initialize_solver()

  phi_test = reshape([  2.43576516357,  4.58369841267,  1.5626711117,  1.31245374786,  1.12046360588,  &
                        0.867236739559, 0.595606769942, 2.47769600029, 4.77942918468,   1.71039215, &
                        1.45482285016, 1.2432932006, 1.00395695756, 0.752760077886,    2.5169315, &
                        4.97587877605, 1.84928362206, 1.58461198915, 1.35194171606,  1.118058716, &
                        0.810409774028, 2.59320903064, 5.23311939144, 1.97104981208,  1.694307587, &
                        1.44165108478, 1.20037776749, 0.813247000713, 2.70124816247,  5.529676584, &
                        2.07046672497, 1.78060787735, 1.51140559905, 1.25273492166, 0.8089175035, &
                        2.79641531407, 5.78666661987, 2.15462056117, 1.85286457556,  1.569442902, &
                        1.29575568046, 0.813378868173, 2.87941186529, 6.00774402332,  2.225613264, &
                        1.91334927054, 1.61778278393, 1.33135223233, 0.819884638625,   2.95082918, &
                        6.19580198153, 2.28505426287, 1.96372778133, 1.65788876716,  1.360806309, &
                        0.82640046716, 3.01116590643, 6.35316815516, 2.3341740765,  2.005220713, &
                        1.69082169384, 1.38498482157, 0.83227605712, 3.06083711902,  6.481707642, &
                        2.37390755792, 2.0387192711, 1.71734879522, 1.40447856797, 0.8372837595, &
                        3.10018046121, 6.58289016281, 2.40495581492, 2.06486841143,  1.738020841, &
                        1.4196914264, 0.841334574174, 3.12946077671, 6.6578387922,  2.427832061, &
                        2.08412599358, 1.75322625595, 1.43089755336, 0.844390210178,  3.148873662, &
                        6.70736606465, 2.44289487705, 2.09680407626, 1.76322843396,   1.43827772, &
                        0.846433375617, 3.15854807829, 6.73199979835, 2.4503712844,  2.103096645, &
                        1.76819052183, 1.44194181402, 0.847456401368, 3.15854807829,  6.731999798, &
                        2.4503712844, 2.10309664539, 1.76819052183, 1.44194181402, 0.8474564014, &
                        3.14887366178, 6.70736606465, 2.44289487705, 2.09680407626,  1.763228434, &
                        1.43827772036, 0.846433375617, 3.12946077671, 6.6578387922,  2.427832061, &
                        2.08412599358, 1.75322625595, 1.43089755336, 0.844390210178,  3.100180461, &
                        6.58289016281, 2.40495581492, 2.06486841143, 1.73802084073,  1.419691426, &
                        0.841334574174, 3.06083711902, 6.48170764214, 2.37390755792,  2.038719271, &
                        1.71734879522, 1.40447856797, 0.837283759523, 3.01116590643,  6.353168155, &
                        2.3341740765, 2.00522071328, 1.69082169384, 1.38498482157, 0.8322760571, &
                        2.95082917982, 6.19580198153, 2.28505426287, 1.96372778133,  1.657888767, &
                        1.36080630864, 0.82640046716, 2.87941186529, 6.00774402332,  2.225613264, &
                        1.91334927054, 1.61778278393, 1.33135223233, 0.819884638625,  2.796415314, &
                        5.78666661987, 2.15462056117, 1.85286457556, 1.56944290225,   1.29575568, &
                        0.813378868173, 2.70124816247, 5.52967658354, 2.07046672497,  1.780607877, &
                        1.51140559905, 1.25273492166, 0.808917503514, 2.59320903064,  5.233119391, &
                        1.97104981208, 1.69430758654, 1.44165108478, 1.20037776749, 0.8132470007, &
                        2.51693149995, 4.97587877605, 1.84928362206, 1.58461198915,  1.351941716, &
                        1.11805871638, 0.810409774028, 2.47769600029, 4.77942918468,   1.71039215, &
                        1.45482285016, 1.2432932006, 1.00395695756, 0.752760077886,  2.435765164, &
                        4.58369841267, 1.5626711117, 1.31245374786, 1.12046360588, 0.8672367396, &
                        0.595606769942 ],shape(phi_test))
                 
  call solve()

  t1 = testCond(norm2(phi(0,:,:) - phi_test) < 1e-5)
  
  if (t1 == 0) then
    print *, 'solver: vacuum test failed'
  else
    print *, 'all tests passed for solver vacuum'
  end if

  call finalize_solver()
  call finalize_control()

end subroutine test1

! test against detran with reflective conditions
subroutine test2()
  use control
  use solver

  implicit none

  ! initialize types
  integer :: testCond, t1
  double precision :: phi_test(7,28)

  ! Define problem parameters
  call initialize_control('test/reg_test_options', .true.)
  xs_name = 'test/testXS.anlxs'
  boundary_type = [1.0, 1.0]
  material_map = [1, 1, 1]

  call initialize_solver()

  call solve()

  phi_test = reshape((/ 94.51265887,  106.66371692,   75.39710228,   17.95365148,&
                         6.2855009 ,    3.01584797,    1.21327705,   94.51265887,&
                       106.66371692,   75.39710228,   17.95365148,    6.2855009 ,&
                         3.01584797,    1.21327705,   94.51265887,  106.66371692,&
                        75.39710228,   17.95365148,    6.2855009 ,    3.01584797,&
                         1.21327705,   94.51265887,  106.66371692,   75.39710228,&
                        17.95365148,    6.2855009 ,    3.01584797,    1.21327705,&
                        94.51265887,  106.66371692,   75.39710228,   17.95365148,&
                         6.2855009 ,    3.01584797,    1.21327705,   94.51265887,&
                       106.66371692,   75.39710228,   17.95365148,    6.2855009 ,&
                         3.01584797,    1.21327705,   94.51265887,  106.66371692,&
                        75.39710228,   17.95365148,    6.2855009 ,    3.01584797,&
                         1.21327705,   94.51265887,  106.66371692,   75.39710228,&
                        17.95365148,    6.2855009 ,    3.01584797,    1.21327705,&
                        94.51265887,  106.66371692,   75.39710228,   17.95365148,&
                         6.2855009 ,    3.01584797,    1.21327705,   94.51265887,&
                       106.66371692,   75.39710228,   17.95365148,    6.2855009 ,&
                         3.01584797,    1.21327705,   94.51265887,  106.66371692,&
                        75.39710228,   17.95365148,    6.2855009 ,    3.01584797,&
                         1.21327705,   94.51265887,  106.66371692,   75.39710228,&
                        17.95365148,    6.2855009 ,    3.01584797,    1.21327705,&
                        94.51265887,  106.66371692,   75.39710228,   17.95365148,&
                         6.2855009 ,    3.01584797,    1.21327705,   94.51265887,&
                       106.66371692,   75.39710228,   17.95365148,    6.2855009 ,&
                         3.01584797,    1.21327705,   94.51265887,  106.66371692,&
                        75.39710228,   17.95365148,    6.2855009 ,    3.01584797,&
                         1.21327705,   94.51265887,  106.66371692,   75.39710228,&
                        17.95365148,    6.2855009 ,    3.01584797,    1.21327705,&
                        94.51265887,  106.66371692,   75.39710228,   17.95365148,&
                         6.2855009 ,    3.01584797,    1.21327705,   94.51265887,&
                       106.66371692,   75.39710228,   17.95365148,    6.2855009 ,&
                         3.01584797,    1.21327705,   94.51265887,  106.66371692,&
                        75.39710228,   17.95365148,    6.2855009 ,    3.01584797,&
                         1.21327705,   94.51265887,  106.66371692,   75.39710228,&
                        17.95365148,    6.2855009 ,    3.01584797,    1.21327705,&
                        94.51265887,  106.66371692,   75.39710228,   17.95365148,&
                         6.2855009 ,    3.01584797,    1.21327705,   94.51265887,&
                       106.66371692,   75.39710228,   17.95365148,    6.2855009 ,&
                         3.01584797,    1.21327705,   94.51265887,  106.66371692,&
                        75.39710228,   17.95365148,    6.2855009 ,    3.01584797,&
                         1.21327705,   94.51265887,  106.66371692,   75.39710228,&
                        17.95365148,    6.2855009 ,    3.01584797,    1.21327705,&
                        94.51265887,  106.66371692,   75.39710228,   17.95365148,&
                         6.2855009 ,    3.01584797,    1.21327705,   94.51265887,&
                       106.66371692,   75.39710228,   17.95365148,    6.2855009 ,&
                         3.01584797,    1.21327705,   94.51265887,  106.66371692,&
                        75.39710228,   17.95365148,    6.2855009 ,    3.01584797,&
                         1.21327705,   94.51265887,  106.66371692,   75.39710228,&
                        17.95365148,    6.2855009 ,    3.01584797,    1.21327705 &
                       /),shape(phi_test))

  t1 = testCond(all(abs(phi(0,:,:) - phi_test) < 1e-5))

  if (t1 == 0) then
    print *, 'solver: reflection test failed'
  else
    print *, 'all tests passed for solver reflect'
  end if

  call finalize_solver()
  call finalize_control

end subroutine test2

! Eigenvalue test with vacuum conditions
subroutine test3()
  use control
  use solver

  implicit none

  ! initialize types
  integer :: testCond, t1, t2
  double precision :: phi_test(7,28), keff_test

  ! Define problem parameters
  call initialize_control('test/reg_test_options', .true.)
  solver_type = 'eigen'
  source_value = 0.0
  xs_name = 'test/testXS.anlxs'
  allow_fission = .true.

  call initialize_solver()

  keff_test = 0.034011456

  phi_test = reshape([0.019468485445, 0.114484628249, 0.0189399888717, 5.68465508138e-05, 1.320655296e-11, &
                      4.28120461389e-14, 3.76630388955e-14, 0.0198081509491, 0.119352290566, 0.02073589425, &
                      6.30233384112e-05, 1.43398441783e-11, 4.97531642031e-14, 4.71341084306e-14, 0.02013449027, &
                      0.124248883836, 0.0224456263891, 6.86610584387e-05, 1.4144007892e-11, 5.57401672e-14, &
                      4.5935783118e-14, 0.0207904639055, 0.130715920325, 0.0239624342499, 7.342855619e-05, &
                      1.30892315553e-11, 6.00699634681e-14, 3.93532150133e-14, 0.021735974735, 0.1382939657, &
                      0.025236168392, 7.72903383727e-05, 1.20327258044e-11, 6.25482745304e-14, 3.493249165e-14, &
                      0.0225875339335, 0.145013824629, 0.0263538290388, 8.06719096617e-05, 1.124416892e-11, &
                      6.4277505571e-14, 3.27750312927e-14, 0.0233448934223, 0.150912088221, 0.0273270282, &
                      8.36144637144e-05, 1.06527765854e-11, 6.55191927185e-14, 3.148881753e-14, 0.02400787061, &
                      0.156018466289, 0.0281645580972, 8.61474935123e-05, 1.02080558137e-11, 6.643388458e-14, &
                      3.06203707837e-14, 0.024576330559, 0.160356863154, 0.028873027789, 8.829194174e-05, &
                      9.87403902131e-12, 6.71198512894e-14, 2.99994664492e-14, 0.0250501733033, 0.1639462662, &
                      0.0294573559913, 9.00625243986e-05, 9.62519752004e-12, 6.7637060863e-14, 2.954826573e-14, &
                      0.025429324972, 0.166801469857, 0.0299211493749, 9.14694350718e-05, 9.443557118e-12, &
                      6.80219585368e-14, 2.92238323283e-14, 0.0257137317963, 0.168933652711, 0.03026698873, &
                      9.2519581545e-05, 9.31667919543e-12, 6.82965133872e-14, 2.89995807112e-14, 0.02590335617, &
                      0.170350823154, 0.0304966399397, 9.32174647038e-05, 9.23627173798e-12, 6.847369053e-14, &
                      2.88585247088e-14, 0.0259981741716, 0.171058143874, 0.0306112021874, 9.356577758e-05, &
                      9.19726842003e-12, 6.85606795736e-14, 2.8790418574e-14, 0.0259981741716, 0.1710581439, &
                      0.0306112021874, 9.35657775845e-05, 9.19726842003e-12, 6.85606795736e-14, 2.879041857e-14, &
                      0.0259033561676, 0.170350823154, 0.0304966399397, 9.32174647038e-05, 9.236271738e-12, &
                      6.84736905303e-14, 2.88585247088e-14, 0.0257137317963, 0.168933652711, 0.03026698873, &
                      9.2519581545e-05, 9.31667919543e-12, 6.82965133872e-14, 2.89995807112e-14, 0.02542932497, &
                      0.166801469857, 0.0299211493749, 9.14694350718e-05, 9.44355711849e-12, 6.802195854e-14, &
                      2.92238323283e-14, 0.0250501733033, 0.163946266225, 0.0294573559913, 9.00625244e-05, &
                      9.62519752004e-12, 6.7637060863e-14, 2.95482657312e-14, 0.024576330559, 0.1603568632, &
                      0.028873027789, 8.82919417383e-05, 9.87403902131e-12, 6.71198512894e-14, 2.999946645e-14, &
                      0.0240078706077, 0.156018466289, 0.0281645580972, 8.61474935123e-05, 1.020805581e-11, &
                      6.64338845809e-14, 3.06203707837e-14, 0.0233448934223, 0.150912088221, 0.0273270282, &
                      8.36144637144e-05, 1.06527765854e-11, 6.55191927185e-14, 3.148881753e-14, 0.02258753393, &
                      0.145013824629, 0.0263538290388, 8.06719096617e-05, 1.12441689164e-11, 6.427750557e-14, &
                      3.27750312927e-14, 0.021735974735, 0.138293965686, 0.025236168392, 7.729033837e-05, &
                      1.20327258044e-11, 6.25482745304e-14, 3.49324916547e-14, 0.0207904639055, 0.1307159203, &
                      0.0239624342499, 7.34285561909e-05, 1.30892315553e-11, 6.00699634681e-14, 3.935321501e-14, &
                      0.0201344902696, 0.124248883836, 0.0224456263891, 6.86610584387e-05, 1.414400789e-11, &
                      5.57401671993e-14, 4.5935783118e-14, 0.0198081509491, 0.119352290566, 0.02073589425, &
                      6.30233384112e-05, 1.43398441783e-11, 4.97531642031e-14, 4.71341084306e-14, 0.01946848544, &
                      0.114484628249, 0.0189399888717, 5.68465508138e-05, 1.32065529558e-11, 4.281204614e-14, &
                      3.76630388955e-14],shape(phi_test))

  call solve()

  print *, phi(0,:,1)
  print *, phi_test(:,1) * norm2(phi(0,:,1)) / norm2(phi_test(:,1))

  t1 = testCond(norm2(phi(0,:,:) - phi_test) < 1e-5)
  t2 = testCond(abs(d_keff - keff_test) < 1e-6)

  if (t1 == 0) then
    print *, 'solver: eigen vacuum solver phi failed'
  else if (t2 == 0) then
    print *, 'solver: eigen vacuum solver keff failed'
  else
    print *, 'all tests passed for eigen solver vacuum'
  end if

  call finalize_solver()
  call finalize_control()

end subroutine test3

! Eigenvalue test with reflective conditions
subroutine test4()
  use control
  use solver

  implicit none

  ! initialize types
  integer :: testCond, t1, t2
  double precision :: phi_test(7,28), keff_test

  ! Define problem parameters
  call initialize_control('test/reg_test_options', .true.)
  solver_type = 'eigen'
  xs_name = 'test/testXS.anlxs'
  boundary_type = [1.0, 1.0]
  material_map = [1, 1, 1]

  call initialize_solver()

  call solve()

  keff_test = 2.424946538

  phi_test = reshape([1.42745585782, 1.8984087901, 0.0860967990197, 4.10529602673e-05,          0.0, &
                      0.0, 0.0, 1.42745585782, 1.8984087901, 0.08609679902, &
                      4.10529602673e-05, 0.0, 0.0, 0.0,  1.427455858, &
                      1.8984087901, 0.0860967990197, 4.10529602673e-05, 0.0,          0.0, &
                      0.0, 1.42745585782, 1.8984087901, 0.0860967990197, 4.105296027e-05, &
                      0.0, 0.0, 0.0, 1.42745585782,   1.89840879, &
                      0.0860967990197, 4.10529602673e-05, 0.0, 0.0,          0.0, &
                      1.42745585782, 1.8984087901, 0.0860967990197, 4.10529602673e-05,          0.0, &
                      0.0, 0.0, 1.42745585782, 1.8984087901, 0.08609679902, &
                      4.10529602673e-05, 0.0, 0.0, 0.0,  1.427455858, &
                      1.8984087901, 0.0860967990198, 4.10529602673e-05, 0.0,          0.0, &
                      0.0, 1.42745585782, 1.8984087901, 0.0860967990198, 4.105296027e-05, &
                      0.0, 0.0, 0.0, 1.42745585782,   1.89840879, &
                      0.0860967990198, 4.10529602673e-05, 0.0, 0.0,          0.0, &
                      1.42745585782, 1.8984087901, 0.0860967990198, 4.10529602673e-05,          0.0, &
                      0.0, 0.0, 1.42745585782, 1.8984087901, 0.08609679902, &
                      4.10529602673e-05, 0.0, 0.0, 0.0,  1.427455858, &
                      1.8984087901, 0.0860967990198, 4.10529602673e-05, 0.0,          0.0, &
                      0.0, 1.42745585782, 1.8984087901, 0.0860967990198, 4.105296027e-05, &
                      0.0, 0.0, 0.0, 1.42745585782,   1.89840879, &
                      0.0860967990198, 4.10529602673e-05, 0.0, 0.0,          0.0, &
                      1.42745585782, 1.8984087901, 0.0860967990198, 4.10529602673e-05,          0.0, &
                      0.0, 0.0, 1.42745585782, 1.8984087901, 0.08609679902, &
                      4.10529602673e-05, 0.0, 0.0, 0.0,  1.427455858, &
                      1.8984087901, 0.0860967990198, 4.10529602673e-05, 0.0,          0.0, &
                      0.0, 1.42745585782, 1.8984087901, 0.0860967990198, 4.105296027e-05, &
                      0.0, 0.0, 0.0, 1.42745585782,   1.89840879, &
                      0.0860967990198, 4.10529602673e-05, 0.0, 0.0,          0.0, &
                      1.42745585782, 1.8984087901, 0.0860967990198, 4.10529602673e-05,          0.0, &
                      0.0, 0.0, 1.42745585782, 1.8984087901, 0.08609679902, &
                      4.10529602673e-05, 0.0, 0.0, 0.0,  1.427455858, &
                      1.8984087901, 0.0860967990198, 4.10529602673e-05, 0.0,          0.0, &
                      0.0, 1.42745585782, 1.8984087901, 0.0860967990198, 4.105296027e-05, &
                      0.0, 0.0, 0.0, 1.42745585782,   1.89840879, &
                      0.0860967990198, 4.10529602673e-05, 0.0, 0.0,          0.0, &
                      1.42745585782, 1.8984087901, 0.0860967990198, 4.10529602673e-05,          0.0, &
                      0.0, 0.0, 1.42745585782, 1.8984087901, 0.08609679902, &
                      4.10529602673e-05, 0.0, 0.0, 0.0,  1.427455858, &
                      1.8984087901, 0.0860967990198, 4.10529602673e-05, 0.0,          0.0, &
                      0.0],shape(phi_test))

  t1 = testCond(all(abs(phi(0,:,:) - phi_test) < 1e-5))
  t2 = testCond(abs(d_keff - keff_test) < 1e-6)

  if (t1 == 0) then
    print *, 'solver: eigen reflection solver phi failed'
  else if (t2 == 0) then
    print *, 'solver: eigen reflection solver keff failed'
  else
    print *, 'all tests passed for eigen solver reflection'
  end if

  call finalize_solver()
  call finalize_control

end subroutine test4



integer function testCond(condition)
  logical, intent(in) :: condition
  if (condition) then
    write(*,"(A)",advance="no") '.'
    testCond = 1
  else
    write(*,"(A)",advance="no") 'F'
    testCond = 0
  end if

end function testCond
