program test_solver
  !call vacuum1()
  !call reflect1()
  !call eigenV1g()
  !call eigenV2g()
  !call eigenV7g()
  !call eigenR1g()
  !call eigenR2g()
  !call eigenR7g()
  call eigenR1gPin()
  !call eigenR2gPin()
  !call eigenR7gPin()
end program test_solver

! Test against detran with vacuum conditions
subroutine vacuum1()
  use control
  use solver

  implicit none
  
  ! initialize types
  integer :: testCond, t1
  double precision :: phi_test(7,28)
  
  ! Define problem parameters
  call initialize_control('test/reg_test_options', .true.)
  xs_name = 'test/testXS.anlxs'
  allow_fission = .true.
  
  call initialize_solver()

  phi_test = reshape([  2.43576516357,  4.58369841267,  1.5626711117,  1.31245374786,  1.12046360588,  &
                        0.867236739559, 0.595606769942, 2.47769600029, 4.77942918468,   1.71039215, &
                        1.45482285016, 1.2432932006, 1.00395695756, 0.752760077886,    2.5169315, &
                        4.97587877605, 1.84928362206, 1.58461198915, 1.35194171606,  1.118058716, &
                        0.810409774028, 2.59320903064, 5.23311939144, 1.97104981208,  1.694307587, &
                        1.44165108478, 1.20037776749, 0.813247000713, 2.70124816247,  5.529676584, &
                        2.07046672497, 1.78060787735, 1.51140559905, 1.25273492166, 0.8089175035, &
                        2.79641531407, 5.78666661987, 2.15462056117, 1.85286457556,  1.569442902, &
                        1.29575568046, 0.813378868173, 2.87941186529, 6.00774402332,  2.225613264, &
                        1.91334927054, 1.61778278393, 1.33135223233, 0.819884638625,   2.95082918, &
                        6.19580198153, 2.28505426287, 1.96372778133, 1.65788876716,  1.360806309, &
                        0.82640046716, 3.01116590643, 6.35316815516, 2.3341740765,  2.005220713, &
                        1.69082169384, 1.38498482157, 0.83227605712, 3.06083711902,  6.481707642, &
                        2.37390755792, 2.0387192711, 1.71734879522, 1.40447856797, 0.8372837595, &
                        3.10018046121, 6.58289016281, 2.40495581492, 2.06486841143,  1.738020841, &
                        1.4196914264, 0.841334574174, 3.12946077671, 6.6578387922,  2.427832061, &
                        2.08412599358, 1.75322625595, 1.43089755336, 0.844390210178,  3.148873662, &
                        6.70736606465, 2.44289487705, 2.09680407626, 1.76322843396,   1.43827772, &
                        0.846433375617, 3.15854807829, 6.73199979835, 2.4503712844,  2.103096645, &
                        1.76819052183, 1.44194181402, 0.847456401368, 3.15854807829,  6.731999798, &
                        2.4503712844, 2.10309664539, 1.76819052183, 1.44194181402, 0.8474564014, &
                        3.14887366178, 6.70736606465, 2.44289487705, 2.09680407626,  1.763228434, &
                        1.43827772036, 0.846433375617, 3.12946077671, 6.6578387922,  2.427832061, &
                        2.08412599358, 1.75322625595, 1.43089755336, 0.844390210178,  3.100180461, &
                        6.58289016281, 2.40495581492, 2.06486841143, 1.73802084073,  1.419691426, &
                        0.841334574174, 3.06083711902, 6.48170764214, 2.37390755792,  2.038719271, &
                        1.71734879522, 1.40447856797, 0.837283759523, 3.01116590643,  6.353168155, &
                        2.3341740765, 2.00522071328, 1.69082169384, 1.38498482157, 0.8322760571, &
                        2.95082917982, 6.19580198153, 2.28505426287, 1.96372778133,  1.657888767, &
                        1.36080630864, 0.82640046716, 2.87941186529, 6.00774402332,  2.225613264, &
                        1.91334927054, 1.61778278393, 1.33135223233, 0.819884638625,  2.796415314, &
                        5.78666661987, 2.15462056117, 1.85286457556, 1.56944290225,   1.29575568, &
                        0.813378868173, 2.70124816247, 5.52967658354, 2.07046672497,  1.780607877, &
                        1.51140559905, 1.25273492166, 0.808917503514, 2.59320903064,  5.233119391, &
                        1.97104981208, 1.69430758654, 1.44165108478, 1.20037776749, 0.8132470007, &
                        2.51693149995, 4.97587877605, 1.84928362206, 1.58461198915,  1.351941716, &
                        1.11805871638, 0.810409774028, 2.47769600029, 4.77942918468,   1.71039215, &
                        1.45482285016, 1.2432932006, 1.00395695756, 0.752760077886,  2.435765164, &
                        4.58369841267, 1.5626711117, 1.31245374786, 1.12046360588, 0.8672367396, &
                        0.595606769942 ],shape(phi_test))
                 
  call solve()

  t1 = testCond(norm2(phi(0,:,:) - phi_test) < 1e-5)
  
  if (t1 == 0) then
    print *, 'solver: vacuum test failed'
  else
    print *, 'all tests passed for solver vacuum'
  end if

  call finalize_solver()
  call finalize_control()

end subroutine vacuum1

! test against detran with reflective conditions
subroutine reflect1()
  use control
  use solver

  implicit none

  ! initialize types
  integer :: testCond, t1
  double precision :: phi_test(7,28)

  ! Define problem parameters
  call initialize_control('test/reg_test_options', .true.)
  xs_name = 'test/testXS.anlxs'
  boundary_type = [1.0, 1.0]
  material_map = [1, 1, 1]

  call initialize_solver()

  call solve()

  phi_test = reshape((/ 94.51265887,  106.66371692,   75.39710228,   17.95365148,&
                         6.2855009 ,    3.01584797,    1.21327705,   94.51265887,&
                       106.66371692,   75.39710228,   17.95365148,    6.2855009 ,&
                         3.01584797,    1.21327705,   94.51265887,  106.66371692,&
                        75.39710228,   17.95365148,    6.2855009 ,    3.01584797,&
                         1.21327705,   94.51265887,  106.66371692,   75.39710228,&
                        17.95365148,    6.2855009 ,    3.01584797,    1.21327705,&
                        94.51265887,  106.66371692,   75.39710228,   17.95365148,&
                         6.2855009 ,    3.01584797,    1.21327705,   94.51265887,&
                       106.66371692,   75.39710228,   17.95365148,    6.2855009 ,&
                         3.01584797,    1.21327705,   94.51265887,  106.66371692,&
                        75.39710228,   17.95365148,    6.2855009 ,    3.01584797,&
                         1.21327705,   94.51265887,  106.66371692,   75.39710228,&
                        17.95365148,    6.2855009 ,    3.01584797,    1.21327705,&
                        94.51265887,  106.66371692,   75.39710228,   17.95365148,&
                         6.2855009 ,    3.01584797,    1.21327705,   94.51265887,&
                       106.66371692,   75.39710228,   17.95365148,    6.2855009 ,&
                         3.01584797,    1.21327705,   94.51265887,  106.66371692,&
                        75.39710228,   17.95365148,    6.2855009 ,    3.01584797,&
                         1.21327705,   94.51265887,  106.66371692,   75.39710228,&
                        17.95365148,    6.2855009 ,    3.01584797,    1.21327705,&
                        94.51265887,  106.66371692,   75.39710228,   17.95365148,&
                         6.2855009 ,    3.01584797,    1.21327705,   94.51265887,&
                       106.66371692,   75.39710228,   17.95365148,    6.2855009 ,&
                         3.01584797,    1.21327705,   94.51265887,  106.66371692,&
                        75.39710228,   17.95365148,    6.2855009 ,    3.01584797,&
                         1.21327705,   94.51265887,  106.66371692,   75.39710228,&
                        17.95365148,    6.2855009 ,    3.01584797,    1.21327705,&
                        94.51265887,  106.66371692,   75.39710228,   17.95365148,&
                         6.2855009 ,    3.01584797,    1.21327705,   94.51265887,&
                       106.66371692,   75.39710228,   17.95365148,    6.2855009 ,&
                         3.01584797,    1.21327705,   94.51265887,  106.66371692,&
                        75.39710228,   17.95365148,    6.2855009 ,    3.01584797,&
                         1.21327705,   94.51265887,  106.66371692,   75.39710228,&
                        17.95365148,    6.2855009 ,    3.01584797,    1.21327705,&
                        94.51265887,  106.66371692,   75.39710228,   17.95365148,&
                         6.2855009 ,    3.01584797,    1.21327705,   94.51265887,&
                       106.66371692,   75.39710228,   17.95365148,    6.2855009 ,&
                         3.01584797,    1.21327705,   94.51265887,  106.66371692,&
                        75.39710228,   17.95365148,    6.2855009 ,    3.01584797,&
                         1.21327705,   94.51265887,  106.66371692,   75.39710228,&
                        17.95365148,    6.2855009 ,    3.01584797,    1.21327705,&
                        94.51265887,  106.66371692,   75.39710228,   17.95365148,&
                         6.2855009 ,    3.01584797,    1.21327705,   94.51265887,&
                       106.66371692,   75.39710228,   17.95365148,    6.2855009 ,&
                         3.01584797,    1.21327705,   94.51265887,  106.66371692,&
                        75.39710228,   17.95365148,    6.2855009 ,    3.01584797,&
                         1.21327705,   94.51265887,  106.66371692,   75.39710228,&
                        17.95365148,    6.2855009 ,    3.01584797,    1.21327705 &
                       /),shape(phi_test))

  t1 = testCond(all(abs(phi(0,:,:) - phi_test) < 1e-5))

  if (t1 == 0) then
    print *, 'solver: reflection test failed'
  else
    print *, 'all tests passed for solver reflect'
  end if

  call finalize_solver()
  call finalize_control

end subroutine reflect1

! Eigenvalue test with vacuum conditions
subroutine eigenV1g()
  use control
  use solver

  implicit none

  ! initialize types
  integer :: testCond, t1, t2, t3
  double precision :: phi_test(1,10), psi_test(1,4,10), keff_test

  ! Define problem parameters
  call initialize_control('test/eigen_test_options', .true.)
  source_value = 0.0
  boundary_type = [0.0, 0.0]

  call initialize_solver()

  keff_test = 0.360288428

  phi_test = reshape([0.0564043471076, 0.0666389331011, 0.0745649003166, 0.0799703146403, 0.08270993243, &
                      0.0827099324257, 0.0799703146403, 0.0745649003166, 0.0666389331011, 0.05640434711],shape(phi_test))

  psi_test = reshape([0.00610273001614, 0.00261206692141, 0.0411571881995, 0.0570411871604, 0.01785065364, &
                      0.00802347876166, 0.0398306273226, 0.0588081240365, 0.0285510436477, 0.01368198088, &
                      0.0373958307721, 0.0585418920749, 0.0379500139465, 0.0193368169975, 0.03396737924, &
                      0.0562440335846, 0.0458201353708, 0.0247482113172, 0.0296925593475, 0.05196859479, &
                      0.0519685947937, 0.0296925593475, 0.0247482113172, 0.0458201353708, 0.05624403358, &
                      0.0339673792362, 0.0193368169975, 0.0379500139465, 0.0585418920749, 0.03739583077, &
                      0.0136819808803, 0.0285510436477, 0.0588081240365, 0.0398306273226, 0.008023478762, &
                      0.017850653641, 0.0570411871604, 0.0411571881995, 0.00261206692141, 0.006102730016],shape(psi_test))

  call solve()

  t1 = testCond(norm2(phi(0,:,:) - phi_test) < 1e-6)
  t2 = testCond(norm2(psi(:,:,:) - psi_test) < 1e-6)
  t3 = testCond(abs(d_keff - keff_test) < 1e-6)

  if (t1 == 0) then
    print *, 'solver: eigen 1g vacuum solver phi failed'
  else if (t2 == 0) then
    print *, 'solver: eigen 1g vacuum solver psi failed'
  else if (t3 == 0) then
    print *, 'solver: eigen 1g vacuum solver keff failed'
  else
    print *, 'all tests passed for eigen 1g vacuum solver'
  end if

  call finalize_solver()
  call finalize_control()

end subroutine eigenV1g

! Eigenvalue test with vacuum conditions
subroutine eigenV2g()
  use control
  use solver

  implicit none

  ! initialize types
  integer :: testCond, t1, t2, t3
  double precision :: phi_test(2,10), psi_test(2,4,10), keff_test

  ! Define problem parameters
  call initialize_control('test/eigen_test_options', .true.)
  xs_name = 'test/2gXS.anlxs'
  source_value = 0.0
  boundary_type = [0.0, 0.0]

  call initialize_solver()

  keff_test = 0.407513422

  phi_test = reshape([0.0563632719899, 0.00656679898756, 0.0666347472956, 0.00849665711432, 0.07461967843, &
                      0.00988372248932, 0.0800776558788, 0.0107880523736, 0.0828472419002, 0.01123559603, &
                      0.0828472419002, 0.0112355960302, 0.0800776558788, 0.0107880523736, 0.07461967843, &
                      0.00988372248932, 0.0666347472956, 0.00849665711432, 0.0563632719899, 0.006566798988],shape(phi_test))

  psi_test = reshape([0.00603370669513, 0.00107271788004, 0.00258252382625, 0.000491059932538, 0.04118479097, &
                      0.00547327617846, 0.0570482608285, 0.00581543537822, 0.0177111706167, 0.002938519831, &
                      0.0079594447009, 0.00146620681607, 0.0399040183982, 0.00555104696588, 0.0589361975, &
                      0.00634725242648, 0.0284422127587, 0.00432393650432, 0.0136227856733, 0.002406780662, &
                      0.0374807287402, 0.00543667632624, 0.0587210099019, 0.00664806554168, 0.03791767864, &
                      0.00534780111056, 0.0193049154666, 0.00327441221033, 0.034039383019, 0.005137212157, &
                      0.0564195754674, 0.00670784021935, 0.0458751174567, 0.00606954555589, 0.02475363543, &
                      0.00403625175948, 0.0297354456834, 0.00466466649085, 0.0520983943468, 0.00651805001, &
                      0.0520983943468, 0.00651805001001, 0.0297354456834, 0.00466466649085, 0.02475363543, &
                      0.00403625175948, 0.0458751174567, 0.00606954555589, 0.0564195754674, 0.006707840219, &
                      0.034039383019, 0.00513721215656, 0.0193049154666, 0.00327441221033, 0.03791767864, &
                      0.00534780111056, 0.0587210099019, 0.00664806554168, 0.0374807287402, 0.005436676326, &
                      0.0136227856733, 0.0024067806617, 0.0284422127587, 0.00432393650432, 0.0589361975, &
                      0.00634725242648, 0.0399040183982, 0.00555104696588, 0.0079594447009, 0.001466206816, &
                      0.0177111706167, 0.00293851983075, 0.0570482608285, 0.00581543537822, 0.04118479097, &
                      0.00547327617846, 0.00258252382625, 0.000491059932538, 0.00603370669513, 0.00107271788],shape(psi_test))

  call solve()

  t1 = testCond(norm2(phi(0,:,:) - phi_test) < 1e-6)
  t2 = testCond(norm2(psi(:,:,:) - psi_test) < 1e-6)
  t3 = testCond(abs(d_keff - keff_test) < 1e-6)

  if (t1 == 0) then
    print *, 'solver: eigen 2g vacuum solver phi failed'
  else if (t2 == 0) then
    print *, 'solver: eigen 2g vacuum solver psi failed'
  else if (t3 == 0) then
    print *, 'solver: eigen 2g vacuum solver keff failed'
  else
    print *, 'all tests passed for eigen 2g vacuum solver'
  end if

  call finalize_solver()
  call finalize_control()

end subroutine eigenV2g

! Eigenvalue test with vacuum conditions
subroutine eigenV7g()
  use control
  use solver

  implicit none

  ! initialize types
  integer :: testCond, t1, t2, t3
  double precision :: phi_test(7,10), psi_test(7,4,10), keff_test

  ! Define problem parameters
  call initialize_control('test/eigen_test_options', .true.)
  xs_name = 'test/testXS.anlxs'
  source_value = 0.0
  boundary_type = [0.0, 0.0]

  call initialize_solver()

  keff_test = 0.021792913

  phi_test = reshape([0.0181815029809, 0.0958215882452, 0.00387348603411, 7.02552743668e-06,          0.0, &
                      0.0, 0.0, 0.0189871280678, 0.101727762557, 0.004210527582, &
                      7.74827023383e-06, 0.0, 0.0, 0.0, 0.01960064917, &
                      0.106218564632, 0.00446636807733, 8.29572367235e-06, 0.0,          0.0, &
                      0.0, 0.0200141243771, 0.109241777409, 0.00463839720641, 8.663289355e-06, &
                      0.0, 0.0, 0.0, 0.020222206643, 0.1107622305, &
                      0.00472485481494, 8.84785663623e-06, 0.0, 0.0,          0.0, &
                      0.020222206643, 0.110762230505, 0.00472485481494, 8.84785663623e-06,          0.0, &
                      0.0, 0.0, 0.0200141243771, 0.109241777409, 0.004638397206, &
                      8.66328935455e-06, 0.0, 0.0, 0.0, 0.01960064917, &
                      0.106218564632, 0.00446636807733, 8.29572367235e-06, 0.0,          0.0, &
                      0.0, 0.0189871280678, 0.101727762557, 0.00421052758228, 7.748270234e-06, &
                      0.0, 0.0, 0.0, 0.0181815029809, 0.09582158825, &
                      0.00387348603411, 7.02552743668e-06, 0.0, 0.0,          0.0],shape(phi_test))

  psi_test = reshape([0.00131316342911, 0.00748396303651, 0.00033468248811, 6.45424320552e-07,          0.0, &
                      0.0, 0.0, 0.000528297873764, 0.0030339390819, 0.0001372376236, &
                      2.66613009328e-07, 0.0, 0.0, 0.0, 0.009841762583, &
                      0.0542861549709, 0.00233667418353, 4.39662201965e-06, 0.0,          0.0, &
                      0.0, 0.021034970415, 0.108874358787, 0.00428533776824, 7.640152131e-06, &
                      0.0, 0.0, 0.0, 0.00393126669513, 0.02223018096, &
                      0.000984993766917, 1.8883375325e-06, 0.0, 0.0,          0.0, &
                      0.00160104921742, 0.00916763044509, 0.000413849198406, 8.0291763689e-07,          0.0, &
                      0.0, 0.0, 0.00897857110395, 0.0497882452729, 0.002162096372, &
                      4.0913266294e-06, 0.0, 0.0, 0.0, 0.01954043399, &
                      0.102312146665, 0.00409742141333, 7.38227286372e-06, 0.0,          0.0, &
                      0.0, 0.00651602708399, 0.036450575907, 0.0015942406953, 3.03120106e-06, &
                      0.0, 0.0, 0.0, 0.00269870987488, 0.01538948175, &
                      0.000692453141878, 1.34057208362e-06, 0.0, 0.0,          0.0, &
                      0.00804060619255, 0.0448135284288, 0.0019614783246, 3.73049521593e-06,          0.0, &
                      0.0, 0.0, 0.0178112655839, 0.0943127291854, 0.003838882792, &
                      6.98455738532e-06, 0.0, 0.0, 0.0, 0.009034030529, &
                      0.0499836006216, 0.00215668475129, 4.06590895598e-06, 0.0,          0.0, &
                      0.0, 0.0038063924494, 0.0216125217512, 0.000968526702657, 1.870103493e-06, &
                      0.0, 0.0, 0.0, 0.00704059891499, 0.03943164584, &
                      0.00173809525385, 3.32055285102e-06, 0.0, 0.0,          0.0, &
                      0.0158698513056, 0.0849668276528, 0.00351212320859, 6.4496861454e-06,          0.0, &
                      0.0, 0.0, 0.011452811221, 0.0626752140329, 0.002666977958, &
                      4.98493876342e-06, 0.0, 0.0, 0.0, 0.00490913159, &
                      0.0277502129819, 0.00123764601008, 2.38236259673e-06, 0.0,          0.0, &
                      0.0, 0.00599206260612, 0.0337174674303, 0.0014955320397, 2.868602162e-06, &
                      0.0, 0.0, 0.0, 0.0137412323159, 0.07438077632, &
                      0.00312023913597, 5.7815034172e-06, 0.0, 0.0,          0.0, &
                      0.0137412323159, 0.0743807763218, 0.00312023913597, 5.7815034172e-06,          0.0, &
                      0.0, 0.0, 0.00599206260612, 0.0337174674303, 0.00149553204, &
                      2.86860216218e-06, 0.0, 0.0, 0.0, 0.00490913159, &
                      0.0277502129819, 0.00123764601008, 2.38236259673e-06, 0.0,          0.0, &
                      0.0, 0.011452811221, 0.0626752140329, 0.00266697795758, 4.984938763e-06, &
                      0.0, 0.0, 0.0, 0.0158698513056, 0.08496682765, &
                      0.00351212320859, 6.4496861454e-06, 0.0, 0.0,          0.0, &
                      0.00704059891499, 0.0394316458381, 0.00173809525385, 3.32055285102e-06,          0.0, &
                      0.0, 0.0, 0.0038063924494, 0.0216125217512, 0.0009685267027, &
                      1.87010349295e-06, 0.0, 0.0, 0.0, 0.009034030529, &
                      0.0499836006216, 0.00215668475129, 4.06590895598e-06, 0.0,          0.0, &
                      0.0, 0.0178112655839, 0.0943127291854, 0.00383888279207, 6.984557385e-06, &
                      0.0, 0.0, 0.0, 0.00804060619255, 0.04481352843, &
                      0.0019614783246, 3.73049521593e-06, 0.0, 0.0,          0.0, &
                      0.00269870987488, 0.0153894817482, 0.000692453141878, 1.34057208362e-06,          0.0, &
                      0.0, 0.0, 0.00651602708399, 0.036450575907, 0.001594240695, &
                      3.03120105968e-06, 0.0, 0.0, 0.0, 0.01954043399, &
                      0.102312146665, 0.00409742141333, 7.38227286372e-06, 0.0,          0.0, &
                      0.0, 0.00897857110395, 0.0497882452729, 0.00216209637202, 4.091326629e-06, &
                      0.0, 0.0, 0.0, 0.00160104921742, 0.009167630445, &
                      0.000413849198406, 8.0291763689e-07, 0.0, 0.0,          0.0, &
                      0.00393126669513, 0.0222301809645, 0.000984993766917, 1.8883375325e-06,          0.0, &
                      0.0, 0.0, 0.021034970415, 0.108874358787, 0.004285337768, &
                      7.64015213055e-06, 0.0, 0.0, 0.0, 0.009841762583, &
                      0.0542861549709, 0.00233667418353, 4.39662201965e-06, 0.0,          0.0, &
                      0.0, 0.000528297873764, 0.0030339390819, 0.000137237623638, 2.666130093e-07, &
                      0.0, 0.0, 0.0, 0.00131316342911, 0.007483963037, &
                      0.00033468248811, 6.45424320552e-07, 0.0, 0.0,          0.0],shape(psi_test))

  call solve()

  t1 = testCond(norm2(phi(0,:,:) - phi_test) < 1e-6)
  t2 = testCond(norm2(psi(:,:,:) - psi_test) < 1e-6)
  t3 = testCond(abs(d_keff - keff_test) < 1e-6)

  if (t1 == 0) then
    print *, 'solver: eigen 7g vacuum solver phi failed'
  else if (t2 == 0) then
    print *, 'solver: eigen 7g vacuum solver psi failed'
  else if (t3 == 0) then
    print *, 'solver: eigen 7g vacuum solver keff failed'
  else
    print *, 'all tests passed for eigen 7g vacuum solver'
  end if

  call finalize_solver()
  call finalize_control()

end subroutine eigenV7g

! Eigenvalue test with reflective conditions for 1 group
subroutine eigenR1g()
  use control
  use solver

  implicit none

  ! initialize types
  integer :: testCond, t1, t2, t3
  double precision :: phi_test, keff_test, psi_test

  ! Define problem parameters
  call initialize_control('test/eigen_test_options', .true.)

  call initialize_solver()

  call solve()

  keff_test = 0.714285714

  phi_test = 0.14285714
  psi_test = 0.07142857

  t1 = testCond(all(abs(phi(0,:,:) - phi_test) < 1e-6))
  t2 = testCond(all(abs(psi(:,:,:) - psi_test) < 1e-6))
  t3 = testCond(abs(d_keff - keff_test) < 1e-6)

  if (t1 == 0) then
    print *, 'solver: eigen 1g reflection solver phi failed'
  else if (t2 == 0) then
    print *, 'solver: eigen 1g reflection solver psi failed'
  else if (t3 == 0) then
    print *, 'solver: eigen 1g reflection solver keff failed'
  else
    print *, 'all tests passed for eigen 1g reflection solver'
  end if

  call finalize_solver()
  call finalize_control

end subroutine eigenR1g

! Eigenvalue test with reflective conditions for 2 groups
subroutine eigenR2g()
  use control
  use solver

  implicit none

  ! initialize types
  integer :: testCond, t1, t2, t3, g
  double precision :: phi_test(2), keff_test, psi_test(2)

  ! Define problem parameters
  call initialize_control('test/eigen_test_options', .true.)
  xs_name = 'test/2gXS.anlxs'

  call initialize_solver()

  call solve()

  keff_test = 0.840336134

  phi_test = [0.14285714, 0.02521008]
  psi_test = [0.07142857, 0.01260504]

  do g = 1, 2
    phi(0,g,:) = phi(0,g,:) - phi_test(g)
    psi(g,:,:) = psi(g,:,:) - psi_test(g)
  end do


  t1 = testCond(all(abs(phi) < 1e-6))
  t2 = testCond(all(abs(psi) < 1e-6))
  t3 = testCond(abs(d_keff - keff_test) < 1e-6)

  if (t1 == 0) then
    print *, 'solver: eigen 2g reflection solver phi failed'
  else if (t2 == 0) then
    print *, 'solver: eigen 2g reflection solver psi failed'
  else if (t3 == 0) then
    print *, 'solver: eigen 2g reflection solver keff failed'
  else
    print *, 'all tests passed for eigen 2g reflection solver'
  end if

  call finalize_solver()
  call finalize_control

end subroutine eigenR2g

! Eigenvalue test with reflective conditions
subroutine eigenR7g()
  use control
  use solver

  implicit none

  ! initialize types
  integer :: testCond, t1, t2, t3, g
  double precision :: phi_test(7), keff_test, psi_test(7)

  ! Define problem parameters
  call initialize_control('test/eigen_test_options', .true.)
  xs_name = 'test/testXS.anlxs'

  call initialize_solver()

  call solve()

  keff_test = 2.424946538

  phi_test = [2.02901618e-01, 2.69843872e-01, 1.22379825e-02, 5.83535529e-06, 0.0, 0.0, 0.0]
  psi_test = [1.01450809e-01, 1.34921936e-01, 6.11899126e-03, 2.91767764e-06, 0.0, 0.0, 0.0]

  do g = 1, 7
    phi(0,g,:) = phi(0,g,:) - phi_test(g)
    psi(g,:,:) = psi(g,:,:) - psi_test(g)
  end do


  t1 = testCond(all(abs(phi(0,:,:)) < 1e-6))
  t2 = testCond(all(abs(psi) < 1e-6))
  t3 = testCond(abs(d_keff - keff_test) < 1e-6)

  if (t1 == 0) then
    print *, 'solver: eigen 7g reflection solver phi failed'
  else if (t2 == 0) then
    print *, 'solver: eigen 7g reflection solver psi failed'
  else if (t3 == 0) then
    print *, 'solver: eigen 7g reflection solver keff failed'
  else
    print *, 'all tests passed for eigen 7g reflection solver'
  end if

  call finalize_solver()
  call finalize_control

end subroutine eigenR7g

! Eigenvalue test with reflect conditions for a pin cell
subroutine eigenR1gPin()
  use control
  use solver

  implicit none

  ! initialize types
  integer :: testCond, t1, t2, t3
  double precision :: phi_test(1,16), psi_test(1,4,16), keff_test

  ! Define problem parameters
  call initialize_control('test/pin_test_options', .true.)

  call initialize_solver()

  keff_test = 0.682474204

  phi_test = reshape([0.133418376522, 0.133560750803, 0.133845902455, 0.134709753202, 0.1359152954, &
                      0.13679997221, 0.137380731077, 0.137668452106, 0.137668452106, 0.1373807311, &
                      0.13679997221, 0.135915295391, 0.134709753202, 0.133845902455, 0.1335607508, &
                      0.133418376521],shape(phi_test))

  psi_test = reshape([0.0656202741575, 0.0674408764052, 0.0679398572054, 0.0667513792286, 0.06458716699, &
                      0.0669599563444, 0.0684555199257, 0.0679842714874, 0.0636485954903, 0.06649843139, &
                      0.0689864340019, 0.069323082577, 0.064072881303, 0.0664662196758, 0.06923564877, &
                      0.0701076766848, 0.0656603104311, 0.0668671833744, 0.0691516008891, 0.0701997839, &
                      0.0669605048823, 0.0672845088417, 0.0689841042776, 0.0701228947714, 0.06800798861, &
                      0.0676972302016, 0.0687435748984, 0.0698740998803, 0.0688297909579, 0.06808770368, &
                      0.0684408611868, 0.0694466780867, 0.0694466780868, 0.0684408611869, 0.06808770368, &
                      0.0688297909578, 0.0698740998803, 0.0687435748984, 0.0676972302015, 0.06800798861, &
                      0.0701228947714, 0.0689841042776, 0.0672845088416, 0.0669605048822, 0.0701997839, &
                      0.0691516008892, 0.0668671833743, 0.0656603104309, 0.0701076766847, 0.06923564877, &
                      0.0664662196757, 0.0640728813028, 0.069323082577, 0.0689864340019, 0.06649843139, &
                      0.0636485954901, 0.0679842714874, 0.0684555199257, 0.0669599563444, 0.06458716699, &
                      0.0667513792285, 0.0679398572054, 0.0674408764051, 0.0656202741573],shape(psi_test))

  call solve()

  phi_test = phi_test / phi_test(1,1) * phi(0,1,1)
  psi_test = psi_test / psi_test(1,1,1) * psi(1,1,1)

  print *, d_keff
  print *, phi

  t1 = testCond(norm2(phi(0,:,:) - phi_test) < 1e-6)
  t2 = testCond(norm2(psi(:,:,:) - psi_test) < 1e-6)
  t3 = testCond(abs(d_keff - keff_test) < 1e-6)

  if (t1 == 0) then
    print *, 'solver: eigen 7g reflect pin solver phi failed'
  else if (t2 == 0) then
    print *, 'solver: eigen 7g reflect pin solver psi failed'
  else if (t3 == 0) then
    print *, 'solver: eigen 7g reflect pin solver keff failed'
  else
    print *, 'all tests passed for eigen 7g reflect pin solver'
  end if

  call finalize_solver()
  call finalize_control()

end subroutine eigenR1gPin

! Eigenvalue test with reflect conditions for a pin cell
subroutine eigenR2gPin()
  use control
  use solver

  implicit none

  ! initialize types
  integer :: testCond, t1, t2, t3
  double precision :: phi_test(2,16), psi_test(2,4,16), keff_test

  ! Define problem parameters
  call initialize_control('test/pin_test_options', .false.)
  xs_name = 'test/2gXS.anlxs'
  outer_print = .true.

  call initialize_solver()

  keff_test = 0.850668503

  phi_test = reshape([0.134071979429, 0.0487423057646, 0.134216039201, 0.0482270762295, 0.1345045684, &
                      0.047194532886, 0.135289218801, 0.0422094982328, 0.136222856937, 0.03547685381, &
                      0.136726804997, 0.0317877930357, 0.136985217053, 0.0298536270585, 0.1370939509, &
                      0.0290226819783, 0.137093950862, 0.0290226819783, 0.136985217053, 0.02985362706, &
                      0.136726804998, 0.0317877930358, 0.136222856937, 0.0354768538052, 0.1352892188, &
                      0.0422094982329, 0.13450456836, 0.0471945328862, 0.134216039201, 0.04822707623, &
                      0.134071979429, 0.0487423057648],shape(phi_test))

  psi_test = reshape([0.0660517811682, 0.0289296878876, 0.0675592007197, 0.0205808736083, 0.06805310727, &
                      0.0187178815674, 0.0671985855414, 0.0248498167325, 0.0650043299592, 0.03265848916, &
                      0.067083192701, 0.0223775326152, 0.0685635038838, 0.0167914686072, 0.06844859523, &
                      0.0204001728831, 0.0640527122333, 0.0360533144531, 0.0666264462674, 0.02410503472, &
                      0.0690889292379, 0.0148046619677, 0.0698060104446, 0.015560357932, 0.06481446159, &
                      0.0317972784231, 0.0667603357821, 0.0236541331795, 0.0691476357632, 0.01386597294, &
                      0.0701447139138, 0.0129135460188, 0.0666953140325, 0.022779698478, 0.06734043056, &
                      0.0213007124331, 0.068809356597, 0.014087105404, 0.0695665183938, 0.0127446472, &
                      0.0677282464142, 0.017947621315, 0.0677089911661, 0.0193967305449, 0.06858803192, &
                      0.0144682832356, 0.0692278046613, 0.0127321802021, 0.0682979003894, 0.0153575043, &
                      0.0679565088654, 0.0178764790605, 0.0684250160477, 0.0150110618684, 0.06900932662, &
                      0.0128778302163, 0.068622354375, 0.0139728886472, 0.0681364809661, 0.01667501741, &
                      0.068283651786, 0.0157352999537, 0.0688310117062, 0.013242825399, 0.06883101171, &
                      0.013242825399, 0.0682836517859, 0.0157352999537, 0.0681364809662, 0.01667501741, &
                      0.0686223543752, 0.0139728886472, 0.0690093266245, 0.0128778302162, 0.06842501605, &
                      0.0150110618684, 0.0679565088655, 0.0178764790605, 0.0682979003896, 0.0153575043, &
                      0.0692278046613, 0.0127321802021, 0.0685880319233, 0.0144682832356, 0.06770899117, &
                      0.019396730545, 0.0677282464144, 0.017947621315, 0.0695665183938, 0.0127446472, &
                      0.068809356597, 0.014087105404, 0.0673404305613, 0.0213007124332, 0.06669531403, &
                      0.0227796984781, 0.0701447139139, 0.0129135460188, 0.0691476357632, 0.01386597294, &
                      0.0667603357822, 0.0236541331796, 0.0648144615865, 0.0317972784232, 0.06980601044, &
                      0.0155603579321, 0.0690889292379, 0.0148046619677, 0.0666264462675, 0.02410503472, &
                      0.0640527122336, 0.0360533144533, 0.0684485952343, 0.0204001728832, 0.06856350388, &
                      0.0167914686073, 0.0670831927011, 0.0223775326153, 0.0650043299595, 0.03265848916, &
                      0.0671985855415, 0.0248498167326, 0.0680531072722, 0.0187178815674, 0.06755920072, &
                      0.0205808736084, 0.0660517811685, 0.0289296878877],shape(psi_test))

  call solve()

  phi_test = phi_test / phi_test(1,1) * phi(0,1,1)
  psi_test = psi_test / psi_test(1,1,1) * psi(1,1,1)

  print *, d_keff
  print *, psi
  print *,
  print *, psi_test

  t1 = testCond(norm2(phi(0,:,:) - phi_test) < 1e-6)
  t2 = testCond(norm2(psi(:,:,:) - psi_test) < 1e-6)
  t3 = testCond(abs(d_keff - keff_test) < 1e-6)

  if (t1 == 0) then
    print *, 'solver: eigen 2g reflect pin solver phi failed'
  else if (t2 == 0) then
    print *, 'solver: eigen 2g reflect pin solver psi failed'
  else if (t3 == 0) then
    print *, 'solver: eigen 2g reflect pin solver keff failed'
  else
    print *, 'all tests passed for eigen 2g reflect pin solver'
  end if

  call finalize_solver()
  call finalize_control()

end subroutine eigenR2gPin

! Eigenvalue test with reflect conditions for a pin cell
subroutine eigenR7gPin()
  use control
  use solver

  implicit none

  ! initialize types
  integer :: testCond, t1, t2, t3
  double precision :: phi_test(7,28), psi_test(7,4,28), keff_test

  ! Define problem parameters
  call initialize_control('test/reg_test_options', .true.)
  solver_type = 'eigen'
  source_value = 0.0
  boundary_type = [1.0, 1.0]
  angle_order = 2
  store_psi = .true.

  call initialize_solver()

  keff_test = 1.351553807

  phi_test = reshape([1.02958078851, 1.28950195233, 0.0358076470769, 3.20063827695e-05, 1.478188168e-11, &
                      1.1058720596e-13, 7.25092671088e-14, 1.02957388687, 1.2896728771, 0.03583628188, &
                      3.20449979344e-05, 1.47040010342e-11, 1.10364940222e-13, 6.89012844139e-14,  1.029560077, &
                      1.2900147722, 0.0358936101648, 3.21223506561e-05, 1.45478722654e-11, 1.099212974e-13, &
                      6.10817592793e-14, 1.02951870194, 1.29064748819, 0.0359650743372, 3.221686541e-05, &
                      1.43565344078e-11, 1.09447783162e-13, 5.30542622818e-14, 1.02945660574,  1.291445001, &
                      0.0360328069706, 3.2304493655e-05, 1.41789290545e-11, 1.09070099285e-13, 4.775700897e-14, &
                      1.02940120181, 1.29216165463, 0.0360935745897, 3.23829273616e-05, 1.402045057e-11, &
                      1.08724185351e-13, 4.35442570955e-14, 1.02935233712, 1.29279780109, 0.03614743826, &
                      3.24523045988e-05, 1.38806606415e-11, 1.08412032412e-13, 4.02017221017e-14,  1.029309876, &
                      1.29335375142, 0.0361944519855, 3.25127471247e-05, 1.37591734656e-11, 1.081353555e-13, &
                      3.75624104422e-14, 1.02927369997, 1.2938297774, 0.0362346627834, 3.256436073e-05, &
                      1.36556544108e-11, 1.07895613933e-13, 3.54968287489e-14, 1.0292437077,  1.294226112, &
                      0.0362681108, 3.260723555e-05, 1.35698188173e-11, 1.076940281e-13, 3.390541428e-14, &
                      1.02921981487, 1.2945429472, 0.0362948293734, 3.26414462968e-05, 1.350143099e-11, &
                      1.07531594053e-13, 3.27127322785e-14, 1.02920195412, 1.29478043895, 0.0363148451, &
                      3.26670524953e-05, 1.34503033726e-11, 1.07409094996e-13, 3.18630920523e-14,  1.029190075, &
                      1.29493870252, 0.0363281778777, 3.26840986404e-05, 1.34162958667e-11, 1.073271105e-13, &
                      3.13173189783e-14, 1.02918414379, 1.29501781504, 0.0363348409586, 3.269261433e-05, &
                      1.33993153529e-11, 1.07286023093e-13, 3.10504888466e-14, 1.02918414379,  1.295017815, &
                      0.0363348409586, 3.26926143251e-05, 1.33993153529e-11, 1.07286023093e-13, 3.105048885e-14, &
                      1.02919007496, 1.29493870252, 0.0363281778777, 3.26840986404e-05, 1.341629587e-11, &
                      1.07327110463e-13, 3.13173189785e-14, 1.02920195412, 1.29478043895, 0.0363148451, &
                      3.26670524953e-05, 1.34503033726e-11, 1.07409094996e-13, 3.18630920527e-14,  1.029219815, &
                      1.2945429472, 0.0362948293734, 3.26414462968e-05, 1.35014309917e-11, 1.075315941e-13, &
                      3.27127322791e-14, 1.0292437077, 1.29422611153, 0.0362681108001, 3.260723555e-05, &
                      1.35698188173e-11, 1.07694028102e-13, 3.39054142835e-14, 1.02927369997,  1.293829777, &
                      0.0362346627834, 3.25643607324e-05, 1.36556544108e-11, 1.07895613935e-13, 3.549682875e-14, &
                      1.029309876, 1.29335375142, 0.0361944519855, 3.25127471247e-05, 1.375917347e-11, &
                      1.08135355533e-13, 3.75624104435e-14, 1.02935233712, 1.29279780109, 0.03614743826, &
                      3.24523045988e-05, 1.38806606416e-11, 1.08412032414e-13, 4.02017221033e-14,  1.029401202, &
                      1.29216165463, 0.0360935745897, 3.23829273616e-05, 1.4020450573e-11, 1.087241854e-13, &
                      4.35442570974e-14, 1.02945660574, 1.29144500071, 0.0360328069706, 3.230449366e-05, &
                      1.41789290545e-11, 1.09070099288e-13, 4.77570089746e-14, 1.02951870194,  1.290647488, &
                      0.0359650743372, 3.22168654099e-05, 1.43565344079e-11, 1.09447783165e-13, 5.305426228e-14, &
                      1.02956007676, 1.2900147722, 0.0358936101649, 3.21223506561e-05, 1.454787227e-11, &
                      1.09921297409e-13, 6.10817592827e-14, 1.02957388687, 1.2896728771, 0.03583628188, &
                      3.20449979344e-05, 1.47040010343e-11, 1.10364940226e-13, 6.89012844184e-14,  1.029580789, &
                      1.28950195233, 0.0358076470769, 3.20063827695e-05, 1.4781881684e-11, 1.10587206e-13, &
                      7.25092671145e-14],shape(phi_test))

  psi_test = reshape([0.515103431195, 0.641705652203, 0.0177044812677, 1.57757950999e-05, 7.840760614e-12, &
                      5.61177633947e-14, 4.22616982691e-14, 0.514793856461, 0.645143033251, 0.01796554245, &
                      1.60933722914e-05, 7.20578013593e-12, 5.48368225188e-14, 3.12118778338e-14, 0.5145880056, &
                      0.64701008711, 0.0180784666956, 1.6217384755e-05, 6.96211745592e-12, 5.440182556e-14, &
                      2.73227051282e-14, 0.514583464868, 0.646382164585, 0.0179770900553, 1.606823414e-05, &
                      7.2686207682e-12, 5.5188764622e-14, 3.77016786395e-14, 0.515618771834, 0.6371493009, &
                      0.0174517387418, 1.55099923804e-05, 8.35962064516e-12, 5.68905932337e-14, 4.490265513e-14, &
                      0.51499903838, 0.643295264441, 0.0178560344662, 1.59741021714e-05, 7.439986009e-12, &
                      5.52386997528e-14, 3.43594079007e-14, 0.514381296876, 0.648895959214, 0.01819457263, &
                      1.63457411275e-05, 6.70951611761e-12, 5.39428440493e-14, 2.26551454277e-14, 0.5140583556, &
                      0.651180287804, 0.0182702218566, 1.63884027754e-05, 6.64015063301e-12, 5.410557176e-14, &
                      3.03390229354e-14, 0.516129999221, 0.632711698041, 0.0172182534404, 1.52698319e-05, &
                      8.8279672735e-12, 5.75053095324e-14, 4.6141951962e-14, 0.515203739598, 0.6414672429, &
                      0.0177501708692, 1.58599593642e-05, 7.66423387182e-12, 5.55987919675e-14, 3.678822244e-14, &
                      0.514173540648, 0.650800177844, 0.0183136184099, 1.64780271809e-05, 6.448516565e-12, &
                      5.34697579081e-14, 1.71733817187e-14, 0.513527581378, 0.656101509307, 0.01858458302, &
                      1.67374983673e-05, 5.95199938884e-12, 5.28708442155e-14, 1.87377048217e-14, 0.5162835991, &
                      0.631470374998, 0.0171703035515, 1.52315530538e-05, 8.89683611374e-12, 5.753214658e-14, &
                      4.26046634835e-14, 0.515272331696, 0.64085050047, 0.0177165354936, 1.582495719e-05, &
                      7.73186253219e-12, 5.57092316329e-14, 3.66035386453e-14, 0.514095787101, 0.6515581311, &
                      0.0183636997562, 1.65352174036e-05, 6.33580503586e-12, 5.32390140394e-14, 1.433244544e-14, &
                      0.513315424024, 0.658237717623, 0.0187333438454, 1.69088710995e-05, 5.613780141e-12, &
                      5.21820903494e-14, 1.1579490402e-14, 0.516085878013, 0.633333605086, 0.01729544542, &
                      1.53784124629e-05, 8.60020898778e-12, 5.70546335815e-14, 3.57280552016e-14, 0.5152059269, &
                      0.641433329592, 0.0177532032459, 1.5866406824e-05, 7.64830187021e-12, 5.558738771e-14, &
                      3.42619892511e-14, 0.514148422329, 0.651153855557, 0.0183427233975, 1.651453328e-05, &
                      6.37709370331e-12, 5.32637013936e-14, 1.45760808415e-14, 0.513425271439, 0.6575021534, &
                      0.0187036934602, 1.68853045839e-05, 5.66061497126e-12, 5.213228594e-14, 1.145231474e-14, &
                      0.515896650388, 0.635132002375, 0.0174147431793, 1.55171103232e-05, 8.321883496e-12, &
                      5.65866508683e-14, 3.03299093774e-14, 0.515141298062, 0.642012411317, 0.01778973644, &
                      1.5907734114e-05, 7.56549140922e-12, 5.5455290872e-14, 3.21148302899e-14, 0.5142007361, &
                      0.650735985617, 0.0183204034476, 1.64920461402e-05, 6.42162906908e-12, 5.330512812e-14, &
                      1.48769964474e-14, 0.513536111498, 0.656716683346, 0.0186699954648, 1.685682769e-05, &
                      5.71634538063e-12, 5.21182074229e-14, 1.1375410796e-14, 0.515715401358, 0.6368666836, &
                      0.0175283504604, 1.56479488984e-05, 8.06096389997e-12, 5.61312716799e-14, 2.609093598e-14, &
                      0.515078322259, 0.642587133807, 0.0178260538181, 1.59488190647e-05, 7.483616695e-12, &
                      5.53149773339e-14, 3.01490987148e-14, 0.514252826817, 0.650304970282, 0.01829679218, &
                      1.64678275276e-05, 6.46930001648e-12, 5.33622904798e-14, 1.52350867585e-14, 0.5136482375, &
                      0.655880816169, 0.018632205341, 1.68233757148e-05, 5.78115528496e-12, 5.213928392e-14, &
                      1.13464552346e-14, 0.515541631735, 0.638538723884, 0.0176364130459, 1.577121223e-05, &
                      7.81661233355e-12, 5.56912350156e-14, 2.2761228351e-14, 0.515016878071, 0.6431568985, &
                      0.0178620768553, 1.59895470346e-05, 7.4028529322e-12, 5.51683885481e-14, 2.835204915e-14, &
                      0.51430479414, 0.6498612637, 0.018271942487, 1.64419494077e-05, 6.51999655e-12, &
                      5.34341576462e-14, 1.56513591656e-14, 0.51376195215, 0.65499403113, 0.01859027377, &
                      1.67848740819e-05, 5.85525618928e-12, 5.21949205719e-14, 1.13655477078e-14, 0.5153748575, &
                      0.640149157673, 0.0177390691616, 1.58871669791e-05, 7.58804575781e-12, 5.526898312e-14, &
                      2.01452007794e-14, 0.514956845496, 0.643721119675, 0.0178977296053, 1.602980836e-05, &
                      7.32336587579e-12, 5.50173769213e-14, 2.67113604695e-14, 0.514356739034, 0.6494053256, &
                      0.0182459080092, 1.64144844062e-05, 6.57360924024e-12, 5.35196685617e-14, 1.612779985e-14, &
                      0.513877567968, 0.654055777747, 0.0185441465334, 1.674123812e-05, 5.93888796e-12, &
                      5.2284490614e-14, 1.14352213363e-14, 0.515214609575, 0.641698979761, 0.01783644974, &
                      1.59960631577e-05, 7.37453310907e-12, 5.48666949257e-14, 1.80898019501e-14,  0.514898106, &
                      0.644279223672, 0.0179329385526, 1.60694979991e-05, 7.24531268876e-12, 5.486371117e-14, &
                      2.52152759057e-14, 0.514408763757, 0.648937621777, 0.0182187432142, 1.638550605e-05, &
                      6.630028665e-12, 5.36177287841e-14, 1.66672773081e-14, 0.513995407451, 0.6530654752, &
                      0.0184937644207, 1.66923728204e-05, 6.03231969705e-12, 5.24073269444e-14, 1.156059885e-14, &
                      0.515060432946, 0.643189146173, 0.0179286786501, 1.60981348924e-05, 7.17539264e-12, &
                      5.44863159298e-14, 1.64752931462e-14, 0.514840542298, 0.644830648602, 0.01796763247, &
                      1.61085151723e-05, 7.16884275483e-12, 5.47090813389e-14, 2.38526937115e-14, 0.5144609719, &
                      0.648458624405, 0.0181905035163, 1.63550890021e-05, 6.68914484563e-12, 5.372720734e-14, &
                      1.72734756262e-14, 0.514115803442, 0.652022512036, 0.0184390631066, 1.663817256e-05, &
                      6.13585071805e-12, 5.25627131513e-14, 1.17497038122e-14, 0.514911886682, 0.6446205751, &
                      0.01801587297, 1.61936010811e-05, 6.98998943932e-12, 5.41295849747e-14, 1.520803491e-14, &
                      0.514784038754, 0.645374843703, 0.0180017422716, 1.61467630402e-05, 7.094098458e-12, &
                      5.45551035529e-14, 2.2613221758e-14, 0.51451346828, 0.647968812591, 0.01816124538, &
                      1.63233093246e-05, 6.7508466752e-12, 5.38469335268e-14, 1.79508510149e-14, 0.5142390994, &
                      0.650926245117, 0.0183799730337, 1.65785208031e-05, 6.24981164326e-12, 5.274987377e-14, &
                      1.20139457559e-14, 0.514768543301, 0.645994147553, 0.0180981431718, 1.628266603e-05, &
                      6.817733125e-12, 5.37980582522e-14, 1.42148470269e-14, 0.514728480965, 0.6459112689, &
                      0.0180352008935, 1.61841483765e-05, 7.02121592955e-12, 5.44033245016e-14, 2.148720641e-14, &
                      0.514566359172, 0.647468672761, 0.0181310264407, 1.62902447148e-05, 6.815021337e-12, &
                      5.39756936538e-14, 1.87046064947e-14, 0.514365649821, 0.649775999509, 0.01831641928, &
                      1.65132897494e-05, 6.37456560013e-12, 5.29679636483e-14, 1.23688084628e-14, 0.5146299884, &
                      0.647310708572, 0.0181755933498, 1.63655200448e-05, 6.65807569635e-12, 5.349313087e-14, &
                      1.34386015213e-14, 0.514673755949, 0.646439394105, 0.0180679431466, 1.622058126e-05, &
                      6.9503257641e-12, 5.4255225721e-14, 2.04657438232e-14, 0.514619752099, 0.6469586991, &
                      0.0180999055971, 1.62559747718e-05, 6.88155371052e-12, 5.41122276755e-14, 1.954068026e-14, &
                      0.51449582037, 0.648571067617, 0.0182483214148, 1.64423399796e-05, 6.510509543e-12, &
                      5.32160562679e-14, 1.28347829645e-14, 0.51449582037, 0.648571067617, 0.01824832141, &
                      1.64423399796e-05, 6.51050954303e-12, 5.32160562664e-14, 1.28347829643e-14, 0.5146197521, &
                      0.646958699119, 0.018099905597, 1.62559747718e-05, 6.88155371044e-12, 5.411222767e-14, &
                      1.95406802543e-14, 0.514673755949, 0.646439394105, 0.0180679431466, 1.622058126e-05, &
                      6.95032576417e-12, 5.42552257233e-14, 2.04657438243e-14, 0.51462998842, 0.6473107086, &
                      0.0181755933498, 1.63655200448e-05, 6.65807569641e-12, 5.3493130875e-14, 1.343860152e-14, &
                      0.514365649821, 0.649775999509, 0.0183164192796, 1.65132897494e-05, 6.3745656e-12, &
                      5.29679636469e-14, 1.23688084626e-14, 0.514566359172, 0.647468672761, 0.01813102644, &
                      1.62902447148e-05, 6.81502133684e-12, 5.39756936517e-14, 1.87046064938e-14,  0.514728481, &
                      0.645911268861, 0.0180352008936, 1.61841483765e-05, 7.02121592962e-12, 5.44033245e-14, &
                      2.14872064065e-14, 0.514768543301, 0.645994147553, 0.0180981431718, 1.628266603e-05, &
                      6.81773312507e-12, 5.37980582541e-14, 1.42148470273e-14, 0.51423909942, 0.6509262451, &
                      0.0183799730337, 1.65785208031e-05, 6.24981164321e-12, 5.27498737689e-14, 1.201394576e-14, &
                      0.51451346828, 0.647968812591, 0.018161245382, 1.63233093246e-05, 6.750846675e-12, &
                      5.38469335248e-14, 1.79508510141e-14, 0.514784038755, 0.645374843703, 0.01800174227, &
                      1.61467630402e-05, 7.09409845817e-12, 5.45551035554e-14, 2.26132217594e-14, 0.5149118867, &
                      0.64462057506, 0.0180158729701, 1.61936010811e-05, 6.98998943939e-12, 5.412958498e-14, &
                      1.52080349146e-14, 0.514115803442, 0.652022512036, 0.0184390631066, 1.663817256e-05, &
                      6.13585071801e-12, 5.25627131502e-14, 1.17497038121e-14, 0.514460971878, 0.6484586244, &
                      0.0181905035163, 1.63550890021e-05, 6.68914484557e-12, 5.37272073374e-14, 1.727347563e-14, &
                      0.514840542298, 0.644830648602, 0.0179676324685, 1.61085151723e-05, 7.168842755e-12, &
                      5.47090813414e-14, 2.3852693713e-14, 0.515060432946, 0.643189146173, 0.01792867865, &
                      1.60981348924e-05, 7.1753926399e-12, 5.44863159321e-14, 1.64752931469e-14, 0.5139954075, &
                      0.653065475249, 0.0184937644207, 1.66923728204e-05, 6.03231969701e-12, 5.240732694e-14, &
                      1.15605988485e-14, 0.514408763757, 0.648937621777, 0.0182187432141, 1.638550605e-05, &
                      6.63002866493e-12, 5.36177287823e-14, 1.66672773074e-14, 0.514898105959, 0.6442792237, &
                      0.0179329385526, 1.60694979991e-05, 7.24531268884e-12, 5.48637111716e-14, 2.521527591e-14, &
                      0.515214609575, 0.641698979761, 0.0178364497363, 1.59960631577e-05, 7.374533109e-12, &
                      5.48666949282e-14, 1.80898019508e-14, 0.513877567967, 0.654055777747, 0.01854414653, &
                      1.674123812e-05, 5.93888795954e-12, 5.22844906132e-14, 1.14352213363e-14,  0.514356739, &
                      0.649405325612, 0.0182459080091, 1.64144844062e-05, 6.57360924018e-12, 5.351966856e-14, &
                      1.61277998462e-14, 0.514956845496, 0.643721119675, 0.0178977296053, 1.602980836e-05, &
                      7.32336587587e-12, 5.5017376924e-14, 2.67113604713e-14, 0.515374857544, 0.6401491577, &
                      0.0177390691616, 1.58871669791e-05, 7.5880457579e-12, 5.5268983124e-14, 2.014520078e-14, &
                      0.51376195215, 0.65499403113, 0.0185902737689, 1.67848740819e-05, 5.855256189e-12, &
                      5.21949205712e-14, 1.13655477079e-14, 0.51430479414, 0.6498612637, 0.01827194249, &
                      1.64419494077e-05, 6.51999654998e-12, 5.34341576446e-14, 1.56513591651e-14, 0.5150168781, &
                      0.643156898524, 0.0178620768553, 1.59895470346e-05, 7.40285293229e-12, 5.516838855e-14, &
                      2.83520491497e-14, 0.515541631735, 0.638538723884, 0.017636413046, 1.577121223e-05, &
                      7.81661233364e-12, 5.56912350186e-14, 2.27612283521e-14, 0.513648237487, 0.6558808162, &
                      0.0186322053409, 1.68233757148e-05, 5.78115528493e-12, 5.21392839157e-14, 1.134645523e-14, &
                      0.514252826817, 0.650304970282, 0.0182967921774, 1.64678275276e-05, 6.469300016e-12, &
                      5.33622904783e-14, 1.52350867581e-14, 0.515078322259, 0.642587133807, 0.01782605382, &
                      1.59488190647e-05, 7.48361669551e-12, 5.53149773368e-14, 3.01490987169e-14, 0.5157154014, &
                      0.636866683606, 0.0175283504605, 1.56479488984e-05, 8.06096390007e-12, 5.613127168e-14, &
                      2.60909359828e-14, 0.513536111498, 0.656716683346, 0.0186699954648, 1.685682769e-05, &
                      5.71634538061e-12, 5.21182074225e-14, 1.13754107962e-14, 0.514200736104, 0.6507359856, &
                      0.0183204034476, 1.64920461402e-05, 6.42162906902e-12, 5.33051281215e-14, 1.487699645e-14, &
                      0.515141298062, 0.642012411317, 0.01778973644, 1.5907734114e-05, 7.565491409e-12, &
                      5.5455290875e-14, 3.21148302922e-14, 0.515896650388, 0.635132002375, 0.01741474318, &
                      1.55171103232e-05, 8.3218834966e-12, 5.65866508717e-14, 3.03299093791e-14, 0.5134252714, &
                      0.657502153362, 0.0187036934602, 1.68853045839e-05, 5.66061497124e-12, 5.213228594e-14, &
                      1.14523147425e-14, 0.514148422329, 0.651153855557, 0.0183427233974, 1.651453328e-05, &
                      6.37709370326e-12, 5.32637013923e-14, 1.45760808412e-14, 0.515205926914, 0.6414333296, &
                      0.017753203246, 1.5866406824e-05, 7.64830187031e-12, 5.55873877169e-14, 3.426198925e-14, &
                      0.516085878013, 0.633333605086, 0.017295445417, 1.53784124629e-05, 8.600208988e-12, &
                      5.70546335852e-14, 3.57280552036e-14, 0.513315424024, 0.658237717623, 0.01873334385, &
                      1.69088710995e-05, 5.61378014077e-12, 5.21820903493e-14, 1.15794904022e-14, 0.5140957871, &
                      0.651558131128, 0.0183636997562, 1.65352174036e-05, 6.33580503581e-12, 5.323901404e-14, &
                      1.43324454374e-14, 0.515272331696, 0.64085050047, 0.0177165354937, 1.582495719e-05, &
                      7.73186253229e-12, 5.5709231636e-14, 3.6603538648e-14, 0.516283599101,  0.631470375, &
                      0.0171703035516, 1.52315530538e-05, 8.89683611385e-12, 5.75321465879e-14, 4.260466349e-14, &
                      0.513527581378, 0.656101509307, 0.0185845830232, 1.67374983673e-05, 5.951999389e-12, &
                      5.28708442156e-14, 1.87377048223e-14, 0.514173540648, 0.650800177844, 0.01831361841, &
                      1.64780271809e-05, 6.44851656459e-12, 5.3469757907e-14, 1.71733817187e-14, 0.5152037396, &
                      0.641467242869, 0.0177501708692, 1.58599593642e-05, 7.66423387192e-12, 5.559879197e-14, &
                      3.67882224447e-14, 0.516129999221, 0.632711698041, 0.0172182534404, 1.52698319e-05, &
                      8.82796727362e-12, 5.75053095367e-14, 4.61419519651e-14, 0.514058355646, 0.6511802878, &
                      0.0182702218566, 1.63884027754e-05, 6.64015063301e-12, 5.41055717633e-14, 3.033902294e-14, &
                      0.514381296876, 0.648895959214, 0.0181945726344, 1.63457411275e-05, 6.709516118e-12, &
                      5.39428440484e-14, 2.26551454281e-14, 0.51499903838, 0.643295264441, 0.01785603447, &
                      1.59741021714e-05, 7.43998600929e-12, 5.5238699756e-14, 3.43594079039e-14, 0.5156187718, &
                      0.637149300854, 0.0174517387418, 1.55099923804e-05, 8.35962064529e-12, 5.689059324e-14, &
                      4.49026551357e-14, 0.514583464868, 0.646382164585, 0.0179770900553, 1.606823414e-05, &
                      7.2686207682e-12, 5.51887646229e-14, 3.77016786411e-14, 0.514588005599, 0.6470100871, &
                      0.0180784666956, 1.6217384755e-05, 6.96211745588e-12, 5.44018255553e-14, 2.732270513e-14, &
                      0.514793856461, 0.645143033251, 0.0179655424535, 1.60933722914e-05, 7.205780136e-12, &
                      5.48368225221e-14, 3.12118778371e-14, 0.515103431195, 0.641705652203, 0.01770448127, &
                      1.57757950999e-05, 7.8407606138e-12, 5.61177633996e-14, 4.2261698274e-14],shape(psi_test))

  call solve()

  t1 = testCond(norm2(phi(0,:,:) - phi_test) < 1e-6)
  t2 = testCond(norm2(psi(:,:,:) - psi_test) < 1e-6)
  t3 = testCond(abs(d_keff - keff_test) < 1e-6)

  if (t1 == 0) then
    print *, 'solver: eigen 7g reflect pin solver phi failed'
  else if (t2 == 0) then
    print *, 'solver: eigen 7g reflect pin solver psi failed'
  else if (t3 == 0) then
    print *, 'solver: eigen 7g reflect pin solver keff failed'
  else
    print *, 'all tests passed for eigen 7g reflect pin solver'
  end if

  call finalize_solver()
  call finalize_control()

end subroutine eigenR7gPin

integer function testCond(condition)
  logical, intent(in) :: condition
  if (condition) then
    write(*,"(A)",advance="no") '.'
    testCond = 1
  else
    write(*,"(A)",advance="no") 'F'
    testCond = 0
  end if

end function testCond
