program test_material

use material

implicit none

! initialize types
  integer :: number_materials_test, number_groups_test, number_legendre_test, debugFlag_test
  double precision :: ebounds_test(8), velocity_test(7)
  double precision :: sig_t_test(7,6), sig_f_test(7,6), vsig_f_test(7,6), chi_test(7,6), sig_s_test(7,7,6)
  integer :: t1=1, t2=1, t3=1, t4=1, t5=1, testCond
  
  character(len=10) :: filename = 'test.anlxs'
  
  call create_material(filename)
  
  number_materials_test = 7
  number_groups_test = 7
  number_legendre_test = 8
  debugFlag_test = 0
  
  ebounds_test = [1.000000e+37,4.000000e+00,2.000000e-01,3.000000e-03,4.000000e-05,5.000000e-07,6.000000e-09,0.000000e+00]
  velocity_test = [3.158699e+09,1.265531e+09,2.062621e+08,2.214246e+07,2.447058e+06,4.107856e+05,8.296621e+04]
  sig_t_test = reshape((/0.21623600, 0.30664800, 0.44514700, 0.53631500, 0.55601600, 0.71102300, 1.75422000, &
                         0.22840500, 0.31768300, 0.46417600, 0.55616200, 0.58850800, 0.98602300, 2.18612000, &
                         0.22818900, 0.31742800, 0.46480700, 0.56672900, 0.62346000, 1.25597000, 2.87089000, &
                         0.22807300, 0.31782600, 0.46535500, 0.57498500, 0.64967100, 1.48074000, 3.44862000, &
                         0.15358000, 0.25602200, 0.38234300, 0.28413800, 0.25509500, 0.26036200, 0.29965500, &
                         0.10642700, 0.29292300, 0.83901200, 1.05242000, 1.08411000, 1.89404000, 5.59617000/), &
                         shape(sig_t_test))
  vsig_f_test = reshape((/0.04377570, 0.01259030, 0.00249733, 0.01962850, 0.05301660, 0.52135500, 2.03165000, &
                          0.04867930, 0.01496700, 0.00294972, 0.02593640, 0.07556850, 1.02075000, 3.02363000, &
                          0.05036610, 0.01643930, 0.00432797, 0.03766070, 0.10852500, 1.50444000, 4.39402000, &
                          0.05165750, 0.01756960, 0.00544935, 0.04686690, 0.13377400, 1.90256000, 5.53922000, &
                          0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                          0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000/), &
                          shape(vsig_f_test))
  sig_f_test = reshape((/0.01361113, 0.00467188, 0.00097176, 0.00759461, 0.02030750, 0.19427521, 0.77935654, &
                         0.01502550, 0.00543715, 0.00103467, 0.00912987, 0.02654889, 0.35709163, 1.05926886, &
                         0.01544622, 0.00590706, 0.00150882, 0.01319072, 0.03796532, 0.52515394, 1.53287075, &
                         0.01576693, 0.00626443, 0.00189564, 0.01638571, 0.04672675, 0.66370610, 1.92955102, &
                         0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                         0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000/), &
                         shape(sig_f_test))
  chi_test = reshape((/0.11505700, 0.85043100, 0.03444650, 0.00006613, 0.00000000, 0.00000000, 0.00000000, &
                       0.11924300, 0.84636000, 0.03434360, 0.00005324, 0.00000000, 0.00000000, 0.00000000, &
                       0.12066700, 0.84533500, 0.03392080, 0.00007787, 0.00000000, 0.00000000, 0.00000000, &
                       0.12019500, 0.84612500, 0.03359890, 0.00008078, 0.00000000, 0.00000000, 0.00000000, &
                       0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                       0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000/), &
                       shape(chi_test))
  sig_s_test = reshape((/0.14048300, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                         0.05459350, 0.29019500, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                         0.00446131, 0.01001180, 0.43085600, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                         0.00000568, 0.00000431, 0.00431667, 0.47878400, 0.00000000, 0.00000000, 0.00000000, &
                         0.00000000, 0.00000000, 0.00000000, 0.00523292, 0.39384900, 0.00237858, 0.00000000, &
                         0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00639980, 0.37404100, 0.29393800, &
                         0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00110108, 0.19936300, &
                         0.14662400, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                         0.05830450, 0.30017000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                         0.00444160, 0.01012480, 0.44951000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                         0.00000000, 0.00000436, 0.00427874, 0.49480700, 0.00000000, 0.00000000, 0.00000000, &
                         0.00000000, 0.00000000, 0.00000000, 0.00512990, 0.39902400, 0.00308446, 0.00000000, &
                         0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00587356, 0.37921200, 0.28112700, &
                         0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00136621, 0.23986600, &
                         0.14726300, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                         0.05758530, 0.29941300, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                         0.00457706, 0.01020300, 0.44927000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                         0.00000254, 0.00000341, 0.00432923, 0.49718900, 0.00000000, 0.00000000, 0.00000000, &
                         0.00000000, 0.00000000, 0.00000000, 0.00514779, 0.40136000, 0.00339176, 0.00000000, &
                         0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00554385, 0.37933100, 0.28927500, &
                         0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00110334, 0.20839600, &
                         0.14716000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                         0.05737810, 0.29956700, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                         0.00450849, 0.01013290, 0.44932900, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                         0.00000354, 0.00000526, 0.00425604, 0.49963200, 0.00000000, 0.00000000, 0.00000000, &
                         0.00000084, 0.00000000, 0.00000000, 0.00492227, 0.40310500, 0.00466722, 0.00000000, &
                         0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00523542, 0.37686200, 0.29848800, &
                         0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00084329, 0.19621400, &
                         0.08837600, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                         0.06400420, 0.25312100, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                         0.00098822, 0.00246648, 0.37970800, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                         0.00000000, 0.00000048, 0.00106737, 0.27850300, 0.00000000, 0.00000000, 0.00000000, &
                         0.00000000, 0.00000000, 0.00000000, 0.00118578, 0.25244400, 0.00124143, 0.00000000, &
                         0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00199990, 0.25441700, 0.11445100, &
                         0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00048245, 0.16512900, &
                         0.03819140, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                         0.06354740, 0.20808200, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                         0.00296317, 0.08359460, 0.66334800, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                         0.00004184, 0.00122022, 0.17332300, 0.83999000, 0.00000051, 0.00000000, 0.00000000, &
                         0.00000107, 0.00001572, 0.00228123, 0.20960700, 0.88833800, 0.00173311, 0.00000000, &
                         0.00000000, 0.00000014, 0.00002772, 0.00249045, 0.19246800, 1.84937000, 3.97931000, &
                         0.00000000, 0.00000000, 0.00000003, 0.00000781, 0.00041575, 0.02399500, 1.52784000, &
                         0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                         0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                         0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                         0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                         0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                         0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, &
                         0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000/), &
                         shape(sig_s_test))
  
  ! Test total cross section             
  t1 = testCond(norm2(sig_t - sig_t_test) .lt. 1e-6)
  
  ! Test fission cross section  
  t2 = testCond(norm2(sig_f - sig_f_test) .lt. 1e-6)
  
  ! Test nu * fission cross section  
  t3 = testCond(norm2(vsig_f - vsig_f_test) .lt. 1e-6)
  
  ! Test chi
  t4 = testCond(norm2(chi - chi_test) .lt. 1e-6)
  
  ! Test scattering cross section  
  t5 = testCond(norm2(sig_s(0,:,:,:) - sig_s_test) .lt. 1e-5)
  
  ! Print appropriate output statements
  if (t1 .eq. 0) then
    print *, 'material: sig_t failed'
  else if (t2 .eq. 0) then
    print *, 'material: sig_f failed'
  else if (t3 .eq. 0) then
    print *, 'material: vsig_f failed'
  else if (t4 .eq. 0) then
    print *, 'material: chi failed'
  else if (t5 .eq. 0) then
    print *, 'material: sig_s failed'
  else
    print *, ' all tests passed for material'
  end if
  
end program test_material

integer function testCond(condition)
  logical, intent(in) :: condition
  if (condition) then
    write(*,"(A)",advance="no") '.'
    testCond = 1
  else
    write(*,"(A)",advance="no") 'F'
    testCond = 0
  end if

end function testCond
